# 4.0.x: Migration to flatgraph

Joern uses the domain-specific classes from codepropertygraph, which (up to joern 2.x) were generated by overflowdb (specifically https://github.com/ShiftLeftSecurity/overflowdb and https://github.com/ShiftLeftSecurity/overflowdb-codegen). 
As of joern 4.0.x we replaced overflowdb with it's successor, [flatgraph](https://github.com/joernio/flatgraph). The most important PRs paving the path to flatgraph are https://github.com/ShiftLeftSecurity/codepropertygraph/pull/1769 and https://github.com/joernio/joern/pull/4630. 

### Why the change?
Most importantly, flatgraph brings us about 40% less memory usage as well as faster traversals. The reduced memory footprint is achieved by flatgraph's efficient columnar layout, essentially we hold everything in few (albeit very large) arrays. 
The faster traversals account for about 40% performance improvement for many joern use-cases, e.g. running the default passes while importing a large cpg into joern. Some numbers for Linux 4, as an example for a very large codebase. Numbers are based on my workstation and just rough measurements. 

|                             | joern 4 (flatgraph) | joern 2 (overflowdb) |
| ---------------------       | ------------------- | -------------------- |
| heap after import           |    20g              |      33g             |
| min possible Xmx for import | 30g                 |      80g             |
| time for importCpg          |     11 minutes      |   18 minutes         |
| file size on disk           | 400m                | 2600M                |

To get a rough idea for the size: after importing it into joern the cpg for linux4 has 48M nodes, 431M edges, 630M node properties (mostly `String` and `Integer`) and 115M edge properties (all `String`).

Linux 5 and 6 are considerably larger, so I wasn't able to import them into joern 2 on my workstation (which has 128G physical memory). With joern 4 it works, e.g. with `-Xmx90g` for linux6 :)

Also worth noting: one of overflowdb's features was the overflowing-to-disk mechanism. While it sounds nice to be able to handle graphs larger than the available memory, in practice it was too slow to be useful, so we didn't reimplement it in flatgraph.

### Credits and kudos
Flatgraph is all based on [@bbrehm](https://github.com/bbrehm)'s great ideas of a memory efficient columnar layout on the jvm. He convinced us with a working prototype and very promising benchmarks. From there, I ([@mpollmeier](https://github.com/mpollmeier)), took it to "production readiness" :tm:.

### Why did we leave out version 3?
I'm glad you asked! Version 3 is typically a source for trouble, you know... just look at Gnome 3, Python 3 and many more. The only exception is Scala 3, of course - ymmv :)

